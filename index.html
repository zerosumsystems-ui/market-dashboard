<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-0:#060a11;--bg-1:#0b1019;--bg-2:#111827;--bg-3:#1a2540;--border:#1b2742;--border-l:#263657;--t1:#eaf0fb;--t2:#8fa3c4;--t3:#4f6484;--grn:#10b981;--grn2:#34d399;--red:#ef4444;--red2:#f87171;--red-bg:rgba(239,68,68,.12);--ylw:#eab308;--ylw2:#fde047;--cyn:#06b6d4;--cyn2:#67e8f9;--cyn-bg:rgba(6,182,212,.08);--prp:#a78bfa}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg-0);color:var(--t1);font-family:'Outfit',sans-serif;overflow-x:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.35;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.02'/%3E%3C/svg%3E")}
.orb{position:fixed;border-radius:50%;filter:blur(130px);opacity:.05;pointer-events:none;z-index:0}
.orb.a{width:700px;height:700px;background:var(--grn);top:-250px;right:-150px}
.orb.b{width:500px;height:500px;background:var(--red);bottom:-200px;left:-100px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:.7rem 2rem;background:var(--bg-1);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
.brand{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:1rem;background:linear-gradient(135deg,var(--cyn),var(--prp));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.topbar-r{display:flex;align-items:center;gap:.6rem;font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--t3)}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--grn);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(16,185,129,.5)}50%{opacity:.5;box-shadow:0 0 0 5px rgba(16,185,129,0)}}
.btn{background:var(--cyn-bg);border:1px solid rgba(6,182,212,.2);color:var(--cyn);font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:.3rem .65rem;border-radius:5px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.06em}
.btn:hover{background:rgba(6,182,212,.2)}.btn.ld{opacity:.5;pointer-events:none}
.tabs{display:flex;background:var(--bg-1);border-bottom:1px solid var(--border);padding:0 2rem;overflow-x:auto}
.tab{padding:.65rem 1.2rem;font-family:'JetBrains Mono',monospace;font-size:.66rem;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;text-transform:uppercase;letter-spacing:.07em;white-space:nowrap;user-select:none}
.tab:hover{color:var(--t2)}.tab.active{color:var(--cyn);border-bottom-color:var(--cyn)}
.panel{display:none;padding:1.5rem 2rem 3rem;position:relative;z-index:1}
.panel.active{display:block;animation:fadeUp .4s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.sec{display:flex;align-items:center;gap:1rem;margin:1.8rem 0 1rem}
.sec h2{font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);white-space:nowrap}
.sec .line{flex:1;height:1px;background:var(--border)}
.sec .badge{font-family:'JetBrains Mono',monospace;font-size:.55rem;padding:.2rem .5rem;border-radius:4px;background:var(--cyn-bg);color:var(--cyn);border:1px solid rgba(6,182,212,.15)}
.idx-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:1rem}
.idx-card{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:1.1rem 1.3rem;position:relative;overflow:hidden;transition:border-color .2s}
.idx-card:hover{border-color:var(--border-l)}
.idx-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.idx-card.up::before{background:linear-gradient(90deg,var(--grn),transparent)}
.idx-card.dn::before{background:linear-gradient(90deg,var(--red),transparent)}
.idx-lbl{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.25rem}
.idx-row{display:flex;align-items:baseline;gap:.7rem;flex-wrap:wrap}
.idx-px{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700}
.idx-chg{font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:600}
.idx-chg.up{color:var(--grn2)}.idx-chg.dn{color:var(--red2)}
.idx-bar{margin-top:.5rem;height:3px;background:var(--bg-3);border-radius:2px;overflow:hidden}
.idx-bar-fill{height:100%;border-radius:2px;transition:width 1.2s ease}
.idx-sub{font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--t3);margin-top:.35rem}
.stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
.sc{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;position:relative;overflow:hidden}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.sc.g::before{background:linear-gradient(90deg,var(--grn),transparent)}
.sc.r::before{background:linear-gradient(90deg,var(--red),transparent)}
.sc.y::before{background:linear-gradient(90deg,var(--ylw),transparent)}
.sc.c::before{background:linear-gradient(90deg,var(--cyn),transparent)}
.sc-lbl{font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--t3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.3rem}
.sc-val{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700}
.sc-val.g{color:var(--grn2)}.sc-val.r{color:var(--red2)}.sc-val.y{color:var(--ylw2)}
.sc-sub{font-family:'JetBrains Mono',monospace;font-size:.56rem;color:var(--t3);margin-top:.15rem}
.dist-bar{display:flex;height:34px;border-radius:6px;overflow:hidden;margin:.8rem 0;border:1px solid var(--border)}
.dist-bar div{display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:.55rem;font-weight:600;color:#fff;transition:width 1s ease;min-width:0;overflow:hidden}
.tw{border-radius:10px;border:1px solid var(--border);background:var(--bg-1);overflow-x:auto;box-shadow:0 2px 16px rgba(0,0,0,.2)}
.tw table{width:100%;border-collapse:collapse;font-family:'JetBrains Mono',monospace;font-size:.7rem;min-width:700px}
.tw th{background:var(--bg-2);color:var(--t3);font-size:.56rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;padding:.6rem .55rem;text-align:right;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5;white-space:nowrap}
.tw th:first-child{text-align:left;padding-left:1rem}
.tw td{padding:.45rem .55rem;text-align:right;font-weight:500;color:var(--t1);border-bottom:1px solid rgba(27,39,66,.4);white-space:nowrap}
.tw td:first-child{text-align:left;padding-left:1rem;color:var(--cyn2);font-weight:700}
.tw tbody tr:hover{background:rgba(6,182,212,.04)}
.up-c{color:var(--grn2)}.dn-c{color:var(--red2)}
.hsg{background:rgba(16,185,129,.22);color:var(--grn2)}.hg{background:rgba(52,211,153,.1);color:#86efac}
.hy{background:rgba(234,179,8,.14);color:var(--ylw2)}.hr{background:rgba(252,165,165,.12);color:#fca5a5}
.hsr{background:rgba(239,68,68,.2);color:var(--red2)}
.br{display:inline-block;padding:.12rem .32rem;border-radius:4px;font-weight:700;font-size:.68rem}
.br.bull{background:rgba(16,185,129,.18);color:var(--grn2)}
.br.bear{background:rgba(239,68,68,.18);color:var(--red2)}
.br.neut{background:rgba(234,179,8,.12);color:var(--ylw2)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
canvas{width:100%!important;height:140px!important}
.cc{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:1.2rem}
.cc h3{font-family:'JetBrains Mono',monospace;font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t3);margin-bottom:.7rem}
.shimmer{background:linear-gradient(90deg,var(--bg-2) 25%,var(--bg-3) 50%,var(--bg-2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px;min-height:60px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.err{background:var(--red-bg);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:1rem;font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--red2);margin:1rem 0}
.footer{text-align:center;padding:2rem;font-size:.6rem;color:var(--t3);font-family:'JetBrains Mono',monospace;border-top:1px solid var(--border);margin-top:2rem}
/* Screener styles */
.scr-filters{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;margin-bottom:1rem}
.scr-filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.8rem;margin-top:.8rem}
.scr-fg{display:flex;flex-direction:column;gap:.25rem}
.scr-fg label{font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.scr-fg select,.scr-fg input{background:var(--bg-3);border:1px solid var(--border);border-radius:5px;padding:.4rem .5rem;color:var(--t1);font-family:'JetBrains Mono',monospace;font-size:.68rem;outline:none}
.scr-fg select:focus,.scr-fg input:focus{border-color:var(--cyn)}
.scr-actions{display:flex;gap:.6rem;margin-top:.8rem;align-items:center}
.scr-btn{background:var(--cyn-bg);border:1px solid rgba(6,182,212,.2);color:var(--cyn);font-family:'JetBrains Mono',monospace;font-size:.6rem;padding:.4rem .8rem;border-radius:5px;cursor:pointer;text-transform:uppercase;letter-spacing:.06em}
.scr-btn:hover{background:rgba(6,182,212,.2)}
.scr-btn.rst{background:var(--red-bg);border-color:rgba(239,68,68,.2);color:var(--red2)}
.scr-count{font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--t3);margin-left:auto}
.scr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.8rem}
.scr-card{background:var(--bg-2);border:1px solid var(--border);border-radius:8px;padding:.7rem .8rem;overflow:hidden;transition:border-color .2s}
.scr-card:hover{border-color:var(--border-l)}
.scr-head{display:flex;justify-content:space-between;align-items:baseline}
.scr-tk{font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:700;color:var(--cyn2)}
.scr-px{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:600;color:var(--t1)}
.scr-meta{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:.56rem;margin:.2rem 0 .4rem;flex-wrap:wrap;gap:.3rem}
.scr-vol{color:var(--t3)}
.scr-canvas{width:100%!important;height:160px!important;display:block}
@media(max-width:900px){.g2{grid-template-columns:1fr}.topbar,.tabs,.panel{padding-left:1rem;padding-right:1rem}.idx-grid{grid-template-columns:1fr 1fr}.scr-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.idx-grid{grid-template-columns:1fr}.scr-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="orb a"></div><div class="orb b"></div>
<div class="topbar">
  <div class="brand">MKT COMMAND</div>
  <div class="topbar-r"><div class="live-dot"></div><span id="clock">FMP</span>
  <button class="btn" id="refBtn" onclick="refreshAll()">REFRESH</button></div>
</div>
<div class="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="breadth">Market Breadth</div>
  <div class="tab" data-tab="movers">Movers</div>
  <div class="tab" data-tab="screener">Screener</div>
</div>

<!-- OVERVIEW -->
<div class="panel active" id="panel-overview">
  <div class="sec"><h2>Index Proxies</h2><div class="line"></div><div class="badge">ETF SNAPSHOT</div></div>
  <div class="idx-grid" id="idxCards"><div class="shimmer"></div><div class="shimmer"></div><div class="shimmer"></div><div class="shimmer"></div></div>
  <div class="sec"><h2>Today's Breadth</h2><div class="line"></div><div class="badge">FULL MARKET</div></div>
  <div class="stat-row" id="bStats"><div class="shimmer"></div><div class="shimmer"></div><div class="shimmer"></div><div class="shimmer"></div></div>
  <div class="sec"><h2>Advance / Decline Distribution</h2><div class="line"></div></div>
  <div id="distBar"><div class="shimmer" style="min-height:34px"></div></div>
  <div id="distLeg"></div>
  <div class="sec"><h2>30-Day Price History</h2><div class="line"></div><div class="badge">SPY / QQQ</div></div>
  <div class="g2">
    <div class="cc"><h3>SPY - S&amp;P 500</h3><canvas id="ch-SPY"></canvas></div>
    <div class="cc"><h3>QQQ - NASDAQ 100</h3><canvas id="ch-QQQ"></canvas></div>
  </div>
</div>

<!-- BREADTH -->
<div class="panel" id="panel-breadth">
  <div class="sec"><h2>Live Breadth</h2><div class="line"></div><div class="badge">FROM SNAPSHOT</div></div>
  <div class="stat-row" id="bStatsFull"><div class="shimmer"></div></div>
  <div class="sec"><h2>Historical Breadth (ZeroSumSystems)</h2><div class="line"></div></div>
  <div class="tw"><table>
    <thead><tr><th>Date</th><th>Up 4%+</th><th>Dn 4%+</th><th>4% Ratio</th><th>Up 8%+</th><th>Dn 8%+</th><th>8% Ratio</th><th>5d Avg</th><th>10d Avg</th><th>Adv</th><th>Dec</th><th>Univ</th></tr></thead>
    <tbody id="seedTbl"></tbody>
  </table></div>
</div>

<!-- MOVERS -->
<div class="panel" id="panel-movers">
  <div class="sec"><h2>Top Gainers</h2><div class="line"></div><div class="badge">TODAY</div></div>
  <div class="tw"><table><thead><tr><th>Ticker</th><th>Price</th><th>Change</th><th>% Change</th><th>Volume</th></tr></thead>
  <tbody id="gainTbl"><tr><td colspan="5" style="text-align:center;padding:2rem"><div class="shimmer" style="display:inline-block;width:200px;min-height:20px"></div></td></tr></tbody></table></div>
  <div class="sec"><h2>Top Losers</h2><div class="line"></div></div>
  <div class="tw"><table><thead><tr><th>Ticker</th><th>Price</th><th>Change</th><th>% Change</th><th>Volume</th></tr></thead>
  <tbody id="loseTbl"><tr><td colspan="5" style="text-align:center;padding:2rem"><div class="shimmer" style="display:inline-block;width:200px;min-height:20px"></div></td></tr></tbody></table></div>
</div>

<!-- SCREENER -->
<div class="panel" id="panel-screener">
  <div class="sec"><h2>Stock Screener</h2><div class="line"></div><button class="btn" id="scrFilterToggle">HIDE FILTERS</button></div>
  <div class="scr-filters" id="scrFilterPanel">
    <div class="scr-filters-grid">
      <div class="scr-fg"><label>Ticker</label><input type="text" id="fName" value="" placeholder="e.g. AAPL"></div>
      <div class="scr-fg"><label>Min Price ($)</label><input type="number" id="fMinPrice" value="2" placeholder="2"></div>
      <div class="scr-fg"><label>Max Price ($)</label><input type="number" id="fMaxPrice" value="" placeholder="Any"></div>
      <div class="scr-fg"><label>Min Volume</label><input type="number" id="fMinVol" value="50000" placeholder="50000"></div>
      <div class="scr-fg"><label>Max Volume</label><input type="number" id="fMaxVol" value="" placeholder="Any"></div>
      <div class="scr-fg"><label>Min % Change</label><input type="number" id="fMinChg" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Max % Change</label><input type="number" id="fMaxChg" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Min Gap %</label><input type="number" id="fMinGap" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Max Gap %</label><input type="number" id="fMaxGap" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Min Range %</label><input type="number" id="fMinRange" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Max Range %</label><input type="number" id="fMaxRange" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Min Open ($)</label><input type="number" id="fMinOpen" value="" placeholder="Any"></div>
      <div class="scr-fg"><label>Max Open ($)</label><input type="number" id="fMaxOpen" value="" placeholder="Any"></div>
      <div class="scr-fg"><label>Min From Open %</label><input type="number" id="fMinFromOpen" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Max From Open %</label><input type="number" id="fMaxFromOpen" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Min Rel Volume</label><input type="number" id="fMinRelVol" value="" placeholder="e.g. 2" step="0.1"></div>
      <div class="scr-fg"><label>Max Rel Volume</label><input type="number" id="fMaxRelVol" value="" placeholder="Any" step="0.1"></div>
      <div class="scr-fg"><label>Min Avg Volume</label><input type="number" id="fMinAvgVol" value="" placeholder="Any"></div>
      <div class="scr-fg"><label>Period Vol High</label><select id="fVolHigh"><option value="">Any</option><option value="1">Only Vol Highs</option></select></div>
      <div class="scr-fg"><label>Sort By</label><select id="fSort">
        <option value="changeDesc">% Change (High-Low)</option>
        <option value="changeAsc">% Change (Low-High)</option>
        <option value="volumeDesc">Volume (High-Low)</option>
        <option value="volumeAsc">Volume (Low-High)</option>
        <option value="relVolDesc">Rel Volume (High-Low)</option>
        <option value="priceDesc">Price (High-Low)</option>
        <option value="priceAsc">Price (Low-High)</option>
        <option value="gapDesc">Gap % (High-Low)</option>
        <option value="rangeDesc">Range % (High-Low)</option>
      </select></div>
    </div>
    <div class="scr-actions">
      <button class="scr-btn" id="scrApply">APPLY FILTERS</button>
      <button class="scr-btn rst" id="scrReset">RESET</button>
      <span class="scr-count" id="scrCount"></span>
    </div>
  </div>
  <div class="scr-grid" id="scrGrid"><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div><div class="shimmer" style="min-height:220px"></div></div>
</div>

<div class="footer">Market data powered by Databento · Built by ZeroSumSystems · Not financial advice</div>

<script src="/screener.js"></script>
<script>
// Tab switching
document.querySelectorAll('.tab').forEach(function(t) {
  t.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(x) { x.classList.remove('active'); });
    document.querySelectorAll('.panel').forEach(function(x) { x.classList.remove('active'); });
    t.classList.add('active');
    document.getElementById('panel-' + t.dataset.tab).classList.add('active');
    // Load screener on first visit
    if (t.dataset.tab === 'screener' && !SCREENER._loaded) {
      SCREENER._loaded = true;
      SCREENER.applyAndLoad();
    }
  });
});

// Clock
function tick() {
  var s = new Date().toLocaleString('en-US', {timeZone:'America/New_York', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
  document.getElementById('clock').textContent = s + ' ET';
}
setInterval(tick, 1000); tick();

// Helpers
var fN = function(n, d) { d = d || 2; return n == null ? '--' : Number(n).toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d}); };
var fV = function(v) { if (v >= 1e9) return (v/1e9).toFixed(1)+'B'; if (v >= 1e6) return (v/1e6).toFixed(1)+'M'; if (v >= 1e3) return (v/1e3).toFixed(1)+'K'; return v; };

// INDEX CARDS
async function loadIdx() {
  try {
    var r = await fetch('/api/indices'); var d = await r.json();
    if (d.error) throw new Error(d.error);
    document.getElementById('idxCards').innerHTML = d.map(function(t) {
      var u = t.changePerc >= 0; var p = Math.min(Math.abs(t.changePerc) * 10, 100);
      return '<div class="idx-card ' + (u?'up':'dn') + '"><div class="idx-lbl">' + t.name + '</div><div class="idx-row"><div class="idx-px">' + fN(t.price) + '</div><div class="idx-chg ' + (u?'up':'dn') + '">' + (u?'+':'') + fN(t.change) + ' (' + (u?'+':'') + fN(t.changePerc) + '%)</div></div><div class="idx-bar"><div class="idx-bar-fill" style="width:' + p + '%;background:' + (u?'var(--grn)':'var(--red)') + '"></div></div><div class="idx-sub">O:' + fN(t.open) + ' H:' + fN(t.high) + ' L:' + fN(t.low) + ' Vol:' + fV(t.volume) + '</div></div>';
    }).join('');
  } catch(e) { document.getElementById('idxCards').innerHTML = '<div class="err">' + e.message + '</div>'; }
}

// BREADTH
async function loadBreadth() {
  try {
    var r = await fetch('/api/breadth'); var d = await r.json();
    if (d.error) throw new Error(d.error);
    var bull = d.u4 > d.d4;
    document.getElementById('bStats').innerHTML =
      '<div class="sc ' + (bull?'g':'r') + '"><div class="sc-lbl">Up 4%+ Today</div><div class="sc-val g">' + d.u4 + '</div><div class="sc-sub">Strong movers up</div></div>' +
      '<div class="sc ' + (!bull?'g':'r') + '"><div class="sc-lbl">Down 4%+ Today</div><div class="sc-val r">' + d.d4 + '</div><div class="sc-sub">Strong movers down</div></div>' +
      '<div class="sc ' + (d.r4>=1?'g':'r') + '"><div class="sc-lbl">4% Ratio</div><div class="sc-val ' + (d.r4>=1.5?'g':d.r4>=1?'y':'r') + '">' + d.r4 + '</div><div class="sc-sub">' + (d.r4>=1.5?'Bullish':d.r4>=1?'Neutral':'Bearish') + '</div></div>' +
      '<div class="sc c"><div class="sc-lbl">Universe</div><div class="sc-val" style="color:var(--t2)">' + d.universe.toLocaleString() + '</div><div class="sc-sub">Tracked tickers</div></div>';
    document.getElementById('bStatsFull').innerHTML =
      '<div class="sc g"><div class="sc-lbl">Up 4%+</div><div class="sc-val g">' + d.u4 + '</div></div>' +
      '<div class="sc r"><div class="sc-lbl">Down 4%+</div><div class="sc-val r">' + d.d4 + '</div></div>' +
      '<div class="sc g"><div class="sc-lbl">Up 8%+</div><div class="sc-val g">' + d.u8 + '</div></div>' +
      '<div class="sc r"><div class="sc-lbl">Down 8%+</div><div class="sc-val r">' + d.d8 + '</div></div>' +
      '<div class="sc ' + (d.r4>=1?'g':'r') + '"><div class="sc-lbl">4% Ratio</div><div class="sc-val ' + (d.r4>=1.5?'g':d.r4>=1?'y':'r') + '">' + d.r4 + '</div></div>' +
      '<div class="sc ' + (d.r8>=1?'g':'r') + '"><div class="sc-lbl">8% Ratio</div><div class="sc-val ' + (d.r8>=1.5?'g':d.r8>=1?'y':'r') + '">' + d.r8 + '</div></div>' +
      '<div class="sc c"><div class="sc-lbl">Advancing</div><div class="sc-val g">' + d.adv + '</div></div>' +
      '<div class="sc c"><div class="sc-lbl">Declining</div><div class="sc-val r">' + d.dec + '</div></div>';
    var bk = d.buckets; var tot = d.universe || 1;
    var co = ['#991b1b','#dc2626','#f87171','#fca5a5','#86efac','#34d399','#10b981','#047857'];
    var lb = ['-10%+','-5~10','-2~5','0~-2','0~+2','+2~5','+5~10','+10%+'];
    var vl = [bk.d10,bk.d5,bk.d2,bk.d0,bk.u0,bk.u2,bk.u5,bk.u10];
    document.getElementById('distBar').innerHTML = '<div class="dist-bar">' + vl.map(function(v,i) {
      var pc = v/tot*100; return pc > 0 ? '<div style="width:'+pc+'%;background:'+co[i]+'" title="'+lb[i]+': '+v+'">'+(pc>3?v:'')+'</div>' : '';
    }).join('') + '</div>';
    document.getElementById('distLeg').innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:.8rem;font-family:JetBrains Mono,monospace;font-size:.56rem;color:var(--t3)">' + vl.map(function(v,i) {
      return '<span style="display:flex;align-items:center;gap:.3rem"><span style="width:10px;height:10px;border-radius:2px;background:'+co[i]+'"></span>'+lb[i]+': '+v+'</span>';
    }).join('') + '</div>';
  } catch(e) {
    var m = '<div class="err">' + e.message + '</div>';
    document.getElementById('bStats').innerHTML = m;
    document.getElementById('bStatsFull').innerHTML = m;
  }
}

// MOVERS
async function loadMovers() {
  var dirs = [['gainers','gainTbl'],['losers','loseTbl']];
  for (var k = 0; k < dirs.length; k++) {
    var dir = dirs[k][0], id = dirs[k][1];
    try {
      var r = await fetch('/api/movers?dir=' + dir); var d = await r.json();
      if (d.error) throw new Error(d.error);
      document.getElementById(id).innerHTML = d.map(function(t) {
        var u = t.changePerc >= 0;
        return '<tr><td>' + t.ticker + '</td><td>' + fN(t.price) + '</td><td class="' + (u?'up-c':'dn-c') + '">' + (u?'+':'') + fN(t.change) + '</td><td class="' + (u?'up-c':'dn-c') + '">' + (u?'+':'') + fN(t.changePerc) + '%</td><td style="color:var(--t2)">' + fV(t.volume) + '</td></tr>';
      }).join('');
    } catch(e) { document.getElementById(id).innerHTML = '<tr><td colspan="5"><div class="err">' + e.message + '</div></td></tr>'; }
  }
}

// SPARKLINES
function drawSpark(id, data, color, fill) {
  var c = document.getElementById(id);
  if (!c || !data.length) return;
  var ctx = c.getContext('2d');
  var dp = window.devicePixelRatio || 1;
  var r = c.getBoundingClientRect();
  c.width = r.width * dp; c.height = r.height * dp;
  ctx.scale(dp, dp);
  var w = r.width, h = r.height, pd = 10;
  var mn = Math.min.apply(null, data) * .999, mx = Math.max.apply(null, data) * 1.001, rg = mx - mn || 1;
  var pts = data.map(function(v, i) { return {x: pd + (i/(data.length-1)) * (w-pd*2), y: h - pd - ((v-mn)/rg) * (h-pd*2)}; });
  ctx.beginPath(); ctx.moveTo(pts[0].x, h);
  pts.forEach(function(p) { ctx.lineTo(p.x, p.y); });
  ctx.lineTo(pts[pts.length-1].x, h); ctx.closePath();
  var g = ctx.createLinearGradient(0,0,0,h); g.addColorStop(0, fill); g.addColorStop(1, 'transparent');
  ctx.fillStyle = g; ctx.fill();
  ctx.beginPath(); pts.forEach(function(p, i) { i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y); });
  ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();
  var l = pts[pts.length-1];
  ctx.beginPath(); ctx.arc(l.x, l.y, 4, 0, Math.PI*2); ctx.fillStyle = color; ctx.fill();
  ctx.beginPath(); ctx.arc(l.x, l.y, 2, 0, Math.PI*2); ctx.fillStyle = '#111827'; ctx.fill();
}

async function loadCharts() {
  var charts = [['SPY','#10b981','rgba(16,185,129,.12)'],['QQQ','#06b6d4','rgba(6,182,212,.12)']];
  for (var i = 0; i < charts.length; i++) {
    var tk = charts[i][0], co = charts[i][1], fi = charts[i][2];
    try {
      var r = await fetch('/api/aggs?ticker=' + tk); var d = await r.json();
      var cl = (d.results || []).map(function(x) { return x.close; });
      (function(t, c, f) { setTimeout(function() { drawSpark('ch-'+t, c, co, fi); }, 80); })(tk, cl, fi);
    } catch(e) {}
  }
}

// BREADTH HISTORY (server-computed from Databento)
function u4C(v){return v>=400?'hsg':v>=250?'hg':''} function d4C(v){return v>=400?'hsr':v>=300?'hr':v>=200?'hy':''}
function rC(v){return v>=2?'bull':v>=1?'neut':'bear'} function rB(v){return v>=2?'hsg':v>=1.5?'hg':v>=1?'':v>=.7?'hy':'hsr'}

async function loadBreadthHistory() {
  var tbl = document.getElementById('seedTbl');
  tbl.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:2rem"><div class="shimmer" style="display:inline-block;width:300px;min-height:20px"></div></td></tr>';
  try {
    var r = await fetch('/api/breadth-history?days=20');
    var history = await r.json();
    if (history.error) throw new Error(history.error);
    if (!history.length) {
      tbl.innerHTML = '<tr><td colspan="12" style="text-align:center;color:var(--t3);padding:2rem">No historical breadth data available</td></tr>';
      return;
    }
    var days = history.map(function(day, i) {
      var s5 = history.slice(i, i + 5);
      var r5 = s5.length >= 5 ? +(s5.reduce(function(sum, d) { return sum + d.r4; }, 0) / 5).toFixed(2) : null;
      var s10 = history.slice(i, i + 10);
      var r10 = s10.length >= 10 ? +(s10.reduce(function(sum, d) { return sum + d.r4; }, 0) / 10).toFixed(2) : null;
      return Object.assign({}, day, {r5: r5, r10: r10});
    });
    tbl.innerHTML = days.map(function(r) {
      return '<tr><td>'+r.dateLabel+'</td>' +
        '<td class="'+u4C(r.u4)+'">'+r.u4+'</td>' +
        '<td class="'+d4C(r.d4)+'">'+r.d4+'</td>' +
        '<td class="'+rB(r.r4)+'"><span class="br '+rC(r.r4)+'">'+r.r4.toFixed(2)+'</span></td>' +
        '<td class="'+u4C(r.u8)+'">'+r.u8+'</td>' +
        '<td class="'+d4C(r.d8)+'">'+r.d8+'</td>' +
        '<td class="'+rB(r.r8)+'"><span class="br '+rC(r.r8)+'">'+r.r8.toFixed(2)+'</span></td>' +
        '<td>'+(r.r5!=null?'<span class="br '+rC(r.r5)+'">'+r.r5.toFixed(2)+'</span>':'--')+'</td>' +
        '<td>'+(r.r10!=null?'<span class="br '+rC(r.r10)+'">'+r.r10.toFixed(2)+'</span>':'--')+'</td>' +
        '<td style="color:var(--grn2)">'+r.adv.toLocaleString()+'</td>' +
        '<td style="color:var(--red2)">'+r.dec.toLocaleString()+'</td>' +
        '<td style="color:var(--t3)">'+r.universe.toLocaleString()+'</td></tr>';
    }).join('');
  } catch(e) {
    tbl.innerHTML = '<tr><td colspan="12"><div class="err">'+e.message+'</div></td></tr>';
  }
}

// INIT
SCREENER.init();

async function refreshAll() {
  var b = document.getElementById('refBtn');
  b.classList.add('ld'); b.textContent = 'LOADING...';
  await Promise.allSettled([loadIdx(), loadBreadth(), loadMovers(), loadCharts(), loadBreadthHistory()]);
  b.classList.remove('ld'); b.textContent = 'REFRESH';
}
refreshAll();
window.addEventListener('resize', loadCharts);
</script>
</body>
</html>
